<c-row>
  <c-col md="4">
    <c-card class="h-100">
      <c-card-header class="d-flex justify-content-between align-items-center">
        <strong>چت‌ها</strong>
      </c-card-header>

      <!-- جستجو -->
      <div class="p-3 border-bottom">
        <input 
          type="text" 
          class="form-control" 
          placeholder="جستجوی کاربر..." 
          [(ngModel)]="searchText"
        >
      </div>

      <c-card-body class="p-0">
        <ul class="list-group list-group-flush" style="max-height: 75vh; overflow-y: auto;">
          <li 
            *ngFor="let user of filteredChatList" 
            class="list-group-item list-group-item-action d-flex align-items-center cursor-pointer px-3 py-3"
            [class.bg-light]="selectedUser?.userId === user.userId"
            (click)="selectChat(user)"
          >
            <!-- آواتار دایره‌ای -->
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                 style="width: 50px; height: 50px; font-size: 20px;">
              {{ (user.fullName?.substring(0, 2) || '??') | uppercase }}
            </div>

            <div class="flex-grow-1">
              <div class="fw-bold">{{ user.fullName }}</div>
              <div class="small text-muted text-truncate" style="max-width: 180px;">
                {{ user.lastMessage || 'بدون پیام' }}
              </div>
            </div>

            <div class="text-end">
              <small class="text-muted d-block">
                {{ user.lastMessageTime | date:'shortTime' }}
              </small>
              <c-badge *ngIf="user.unreadCount > 0" color="danger" shape="rounded-pill">
                {{ user.unreadCount }}
              </c-badge>
            </div>
          </li>

          <li *ngIf="chatList.length === 0" class="list-group-item text-center text-muted py-5">
            چتی یافت نشد
          </li>
        </ul>
      </c-card-body>
    </c-card>
  </c-col>

  <c-col md="8">
    <c-card class="h-100 d-flex flex-column" *ngIf="selectedUser; else noChat">
      <c-card-header class="border-bottom d-flex align-items-center">
        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
             style="width: 45px; height: 45px; font-size: 18px;">
          {{ (selectedUser.fullName?.substring(0, 2)) | uppercase }}
        </div>
        <div>
          <strong>{{ selectedUser.fullName }}</strong>
          <small class="text-muted d-block">
            {{ selectedUser.isOnline ? 'آنلاین' : 'آفلاین' }}
          </small>
        </div>
      </c-card-header>

      <c-card-body #chatBody class="flex-grow-1 overflow-auto p-4" style="background: #f8f9fa;">
        <div *ngFor="let msg of messages" class="mb-4 d-flex" [class.flex-row-reverse]="msg.isMine">
          <div 
            class="p-3 rounded-3 max-w-75 shadow-sm"
            [class.bg-primary]="msg.isMine"
            [class.text-white]="msg.isMine"
            [class.bg-white]="!msg.isMine"
            [class.border]="!msg.isMine"
          >
            <div [innerHTML]="msg.content"></div>
            
            <img *ngIf="msg.type === 'Image'" [src]="msg.fileUrl" class="img-fluid rounded mt-2" style="max-width: 280px;">
            <a *ngIf="msg.type === 'File'" [href]="msg.fileUrl" target="_blank" class="text-decoration-underline small d-block mt-2">
              دانلود فایل
            </a>

            <small class="opacity-75 d-block text-end mt-1">
              {{ msg.sentAt | date:'shortTime' }}
            </small>
          </div>
        </div>
      </c-card-body>

      <c-card-footer class="bg-white">
        <div class="d-flex gap-2 align-items-center">
          <input 
            type="text" 
            class="form-control" 
            placeholder="پیام خود را بنویسید..." 
            [(ngModel)]="newMessage"
            (keydown.enter)="onKeydown($event)"
            autocomplete="off"
          >
          <input type="file" class="form-control" style="width: auto;" (change)="onFileSelected($event)">
          <button cButton color="primary" (click)="sendMessage()" [disabled]="!newMessage.trim() && !selectedFile">
            ارسال
          </button>
        </div>
      </c-card-footer>
    </c-card>

    <ng-template #noChat>
      <div class="h-100 d-flex align-items-center justify-content-center text-muted bg-light rounded">
        <h5>یک کاربر را انتخاب کنید تا چت شروع شود</h5>
      </div>
    </ng-template>
  </c-col>
</c-row>